name: Sync to Gitee

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  release:
    types: [published]

jobs:
  # ÂêåÊ≠•‰ª£Á†ÅÂà∞ Gitee
  sync-code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Ëé∑ÂèñÂÆåÊï¥ÂéÜÂè≤ËÆ∞ÂΩï

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GITEE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan gitee.com >> ~/.ssh/known_hosts

      - name: Check Gitee repository
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          echo "Checking if Gitee repository exists..."
          RESPONSE=$(curl -s -w "\n%{http_code}" "https://gitee.com/api/v5/repos/chankay/AnotherSSH?access_token=${GITEE_TOKEN}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" = "404" ]; then
            echo "‚ùå Gitee repository does not exist!"
            echo "Please create the repository first:"
            echo "1. Visit https://gitee.com/projects/new"
            echo "2. Create repository: AnotherSSH"
            echo "3. Do NOT initialize with README"
            exit 1
          elif [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Gitee repository exists"
          else
            echo "‚ö†Ô∏è  Unexpected response code: $HTTP_CODE"
            echo "$RESPONSE"
          fi

      - name: Push to Gitee
        run: |
          # ÈÖçÁΩÆ Git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Ê∑ªÂä† Gitee ËøúÁ®ã‰ªìÂ∫ì
          git remote add gitee git@gitee.com:chankay/AnotherSSH.git || git remote set-url gitee git@gitee.com:chankay/AnotherSSH.git
          
          # Êé®ÈÄÅÊâÄÊúâÂàÜÊîØÂíåÊ†áÁ≠æ
          echo "Pushing main branch..."
          git push -f gitee main || {
            echo "Failed to push main branch"
            echo "This might be the first push. Trying with -u flag..."
            git push -u -f gitee main
          }
          
          echo "Pushing tags..."
          git push -f gitee --tags || echo "No tags to push or push failed"
          
          echo "‚úÖ Successfully pushed to Gitee"

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/id_rsa

  # ÂêåÊ≠• Release ÂíåÈôÑ‰ª∂Âà∞ Gitee
  sync-release:
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'
    needs: sync-code
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get release info
        id: release_info
        run: |
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "RELEASE_NAME=${{ github.event.release.name }}" >> $GITHUB_OUTPUT

      - name: Download release assets from GitHub
        run: |
          mkdir -p release_assets
          gh release download ${{ steps.release_info.outputs.TAG_NAME }} -D release_assets || {
            echo "Failed to download release assets"
            echo "This might be because the release is still being created"
            sleep 10
            gh release download ${{ steps.release_info.outputs.TAG_NAME }} -D release_assets
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Gitee Release and Upload Assets
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          TAG_NAME="${{ steps.release_info.outputs.TAG_NAME }}"
          RELEASE_NAME="${{ github.event.release.name }}"
          
          # ËΩ¨‰πâ release body ‰∏≠ÁöÑÁâπÊÆäÂ≠óÁ¨¶
          RELEASE_BODY=$(cat << 'EOF' | jq -Rs .
          ${{ github.event.release.body }}
          EOF
          )
          
          echo "Creating Gitee Release for ${TAG_NAME}..."
          
          # Ê£ÄÊü• Release ÊòØÂê¶Â∑≤Â≠òÂú®
          EXISTING_RELEASE=$(curl -s "https://gitee.com/api/v5/repos/chankay/AnotherSSH/releases/tags/${TAG_NAME}?access_token=${GITEE_TOKEN}")
          EXISTING_ID=$(echo "$EXISTING_RELEASE" | jq -r '.id')
          
          if [ "$EXISTING_ID" != "null" ] && [ -n "$EXISTING_ID" ]; then
            echo "Release already exists with ID: $EXISTING_ID"
            echo "Deleting existing release..."
            curl -X DELETE "https://gitee.com/api/v5/repos/chankay/AnotherSSH/releases/${EXISTING_ID}?access_token=${GITEE_TOKEN}"
            sleep 2
          fi
          
          # ÂàõÂª∫ Gitee Release
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://gitee.com/api/v5/repos/chankay/AnotherSSH/releases" \
            -H "Content-Type: application/json" \
            -d "{
              \"access_token\": \"${GITEE_TOKEN}\",
              \"tag_name\": \"${TAG_NAME}\",
              \"name\": \"${RELEASE_NAME}\",
              \"body\": ${RELEASE_BODY},
              \"prerelease\": false,
              \"target_commitish\": \"main\"
            }")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Code: $HTTP_CODE"
          echo "Response Body: $BODY"
          
          if [ "$HTTP_CODE" != "201" ]; then
            echo "‚ùå Failed to create Gitee release"
            echo "Response: $BODY"
            exit 1
          fi
          
          # ÊèêÂèñ release id
          RELEASE_ID=$(echo "$BODY" | jq -r '.id')
          
          if [ "$RELEASE_ID" = "null" ] || [ -z "$RELEASE_ID" ]; then
            echo "‚ùå Failed to get release ID"
            exit 1
          fi
          
          echo "‚úÖ Gitee Release created with ID: $RELEASE_ID"
          
          # ‰∏ä‰º†ÊâÄÊúâÈôÑ‰ª∂
          for file in release_assets/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
              echo "Uploading ${filename} (${filesize} bytes)..."
              
              UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                "https://gitee.com/api/v5/repos/chankay/AnotherSSH/releases/${RELEASE_ID}/attach_files" \
                -F "access_token=${GITEE_TOKEN}" \
                -F "file=@${file}")
              
              UPLOAD_CODE=$(echo "$UPLOAD_RESPONSE" | tail -n1)
              
              if [ "$UPLOAD_CODE" = "201" ]; then
                echo "‚úÖ Uploaded ${filename}"
              else
                echo "‚ö†Ô∏è  Failed to upload ${filename} (HTTP ${UPLOAD_CODE})"
                echo "$UPLOAD_RESPONSE"
              fi
            fi
          done
          
          echo "‚úÖ All assets processed!"

      - name: Notify completion
        if: success()
        run: |
          echo "‚úÖ Successfully synced release ${{ steps.release_info.outputs.TAG_NAME }} to Gitee"
          echo "üîó GitHub Release: ${{ github.event.release.html_url }}"
          echo "üîó Gitee Release: https://gitee.com/chankay/AnotherSSH/releases/${{ steps.release_info.outputs.TAG_NAME }}"

